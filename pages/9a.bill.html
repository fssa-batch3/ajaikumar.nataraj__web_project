<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bill</title>
    <link rel="stylesheet" href="../assets/CSS/9a-bill.css" />
  </head>
  <body>
    <header>
      <img src="../assets/image/logo.png" alt="logo" width="130px" />
      <h4 class="btn">Your Product's Bill</h4>
      <img
        class="btn"
        src="../assets/image/profile.png"
        alt="profile"
        width="110px"
        onclick="profile()"
      />
    </header>

    <button class="btn" onclick="download()">download the Bill</button>

    <table>
      <div class="details">
        <h3 class="btn">Your Delivery details:</h3>
        <div class="detail">
          <input disabled type="text" id="First_name" placeholder="name" />
          <input
            type="number"
            id="Phone_Number"
            placeholder="Phone number"
            maxlength="10"
            disabled
          />
          <input
            class="address_input"
            type="text"
            id="Land_Address"
            required
            placeholder="Delivery Address"
            disabled
          />
          <!-- <input type="date" id="Pickup_date" placeholder="Pickup date" /> -->
        </div>
      </div>
    </table>

    <div class="amount_total">
      <table>
        <tr>
          <td>Total Amount</td>
          <td></td>
          <td id="operoation"></td>
        </tr>
      </table>
    </div>

    <input disabled id="buyer_id" type="number" />

    <footer class="btn">
      <img
        src="../assets/image/smiling-face.gif"
        alt="smiling-face"
        width="50px"
      />
      Thanks for Purchasing
      <img src="../assets/image/sparkling-heart.gif" alt="heart" width="50px" />
      We always Welcomes you!
    </footer>

    <script>
      let Card = JSON.parse(localStorage.getItem("added_list"));

      let buyer_info = JSON.parse(localStorage.getItem("buyer_info"));
      console.log(buyer_info);

      let login_id = JSON.parse(localStorage.getItem("buyer_logIn"));
      console.log(login_id);

      const get_obj = buyer_info.find((e) => e.Email === login_id);
      console.log(get_obj);

      let total = 0;

      let btn = document.createElement("button");
      btn.innerText = "Place & Back";
      btn.setAttribute("id", "submit");
      btn.setAttribute("class", "btn");
      document.querySelector("table").append(btn);

      let table_card = document.createElement("table");

      let th_tr1 = document.createElement("tr");
      table_card.append(th_tr1);

      let th1_tr = document.createElement("th");
      th1_tr.innerText = "Products Name";
      th_tr1.append(th1_tr);

      let th2_tr = document.createElement("th");
      th2_tr.innerText = "Quantity";
      th_tr1.append(th2_tr);

      let th3_tr = document.createElement("th");
      th3_tr.innerText = "Amount";
      th_tr1.append(th3_tr);

      for (let i = 0; i < Card.length; i++) {
        let td_tr2 = document.createElement("tr");
        table_card.append(td_tr2);

        let td1_tr = document.createElement("td");
        td1_tr.innerText = Card[i]["Name"];
        td_tr2.append(td1_tr);

        let td2_tr = document.createElement("td");
        td2_tr.innerText = Card[i]["bQty"] + " kg";
        td_tr2.append(td2_tr);

        let td3_tr = document.createElement("td");
        td3_tr.innerText = "Rs. " + Card[i]["Price"] * Card[i]["bQty"];
        td_tr2.append(td3_tr);

        total += parseInt(Card[i]["Price"]) * parseInt(Card[i]["bQty"]);

        // let user_point = document.getElementById("submit");
        // user_point.addEventListener("click", function (event) {
        //   event.preventDefault();
        //   // let count = 0;
        //   // count += 2;
        //   console.log(get_obj);
        //   let count = (get_obj.points += 1);
        //   console.log(get_obj);
        //   let user_point = get_obj["points"];
        //   // console.log(user_point);
        //   let change_value = Object.assign(count, user_point);
        //   console.log(change_value);
        //   localStorage.setItem("buyer_info", JSON.stringify(buyer_info));
        // });

        document.querySelector("table").append(table_card);
      }

      const today = new Date();
      const year = today.getFullYear();
      let month = today.getMonth() + 1;
      let day = today.getDate();

      if (day <= 28) {
        day = day + 2;
      }

      if (day > 28) {
        day = 30 - 28;
        month = month + 1;
      }

      // add leading zero if month or day is a single digit
      if (month < 10) {
        month = "0" + month;
      }

      if (day < 10) {
        day = "0" + day;
      }

      const currentDate = `${year}-${month}-${day}`;

      console.log(currentDate);

      document
        .getElementById("submit")
        .addEventListener("click", function (event) {
          event.preventDefault();
          let Data = JSON.parse(localStorage.getItem("added_list"));
          let newData = JSON.parse(localStorage.getItem("Ordered_list"));
          let orderedData = [];
          let billId = Date.now();
          let buyer_id = get_obj["id"];
          let Delivery_date = currentDate;

          let order = {
            products: Data,
            billId: billId,
            buyer_id,
            Delivery_date,
          };

          orderedData.push(order);

          console.log(orderedData);

          // console.log(order);
          if (newData != null) {
            orderedData = JSON.parse(localStorage.getItem("Ordered_list"));

            orderedData.push(order);

            localStorage.setItem("Ordered_list", JSON.stringify(orderedData));
          } else {
            let orderedData = [];

            let order = {
              products: Data,
              billId: billId,
              buyer_id,
              Delivery_date,
            };

            orderedData.push(order);
            localStorage.setItem("Ordered_list", JSON.stringify(orderedData));
          }

          // localStorage.removeItem("added_list");
          // window.location.href = "/pages/5a-fruits.html";
        });
    </script>
    <script>
      let total_value = document.getElementById("operoation");
      total_value.append("â‚¹" + total);

      const oneUser = JSON.parse(localStorage.getItem("buyer_logIn"));

      const info = JSON.parse(localStorage.getItem("buyer_info"));
      let select_user = info.find(function (event) {
        let customerEmail = event["Email"];
        if (info == customerEmail) {
          return true;
        } else if (oneUser == customerEmail) {
          return true;
        }
      });

      console.log(select_user);
      // to get value from registration form
      const id = document.getElementById("buyer_id");
      const phNo = document.getElementById("Phone_Number");
      const userName = document.getElementById("First_name");
      // const transport_DOB = document.getElementById("Pickup_date");
      const Land_Address = document.getElementById("Land_Address");

      // Compare the values
      id.value = select_user["id"];
      phNo.value = select_user["Phone_number"];
      userName.value = select_user["FullName"];
      Land_Address.value = select_user["Land_Address"] || " ";
      // transport_DOB.value = select_user["transport_DOB"];

      function download() {
        window.print();
      }
      function profile() {
        window.location.href = "/pages/profile_buy.html";
      }
    </script>
  </body>
</html>
